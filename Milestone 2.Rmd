---
title: "Milestone 2"
author: "Alyssa Monda"
date: "3/28/2017"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Downloaded packages 
library(phyloseq)
library(dada2)
library(ggplot2)
library(biom)
library(devtools)
library(knitr)
library(mixOmics)
library(tidyverse)
library(vegan)
library(mixOmics)
library(readxl)
library(tableone)
library(ReporteRs)
library(magrittr)
```
##Directions

For this milestone we expect that you will have acquired, cleaned, and explored your dataset. You will document these activities in your files. You will also explain in detail the components of your final analysis. If you have deviated from your original plans, please describe what is different and the reasons that have led to this. You will explain your workflow, that is, how you went from acquiring your data to getting (close to) an answer to your question. Are there ancillary questions that have arisen as you have gone through this process? What are they?

As a ballpark number, this document should be about 10 pages of text, tables, and figures.

##Change in Plans
Originally I had described using a different dataset to investigate the relationship between butyrate producing taxa (BPT) of the gut microbiome and inflammatory conditions. After beginning the data wrangling process I discovered the variables within the dataset did not match up in a way that made answering my question possible. The majority of the samples were from the oral microbiome and very few individuals had a positive value for an inflammatory disease as well as a gut sample, most of the time they only had oral samples on these individuals. While looking for a new dataset I stumbled upon the data from American Gut and realized they had 3 variables relating to physical activity. 
Although this may seem like a significant change in plans, my purpose for investigating the aforementioned data was to assess whether a relationship existed between BPT and chronic conditions, because there is an increase in BPT seen in animal models observing exercise and the gut microbiome. Little is known about the mechanisms involved in the relationship between exercise and reduction of inflammation. I hypothesize changes in the gut microbiome as one of the possible pathways for the anti-inflammatory effects of moderate intensity, routine, exercise. I knew this task would involve investing more time into cleaning and analyzing this data, its significance to my research interests made the additional effort worth it. To my knowledge there are only 3 studies published investigating the relationship between exercise and the gut microbiome. These studies have small sample sizes, and the methods are of varying quality. With the current plan to propose a longitudinal study to characterize the gut microbiome after participation in a routine, aerobic, exercise intervention for my dissertation, the data from this study will be a wonderful addition to my future proposal.

##Study Aims
Aim 1: Characterize the alpha/beta diversity of the gut microbiome as it relates to frequency and location of exercise. 
  
Aim 2: If a relationship exists, investigate the associations between exercise and butyrate producing taxa.  

##Import Data
Import Meta Data
```{r}
library(readr)
Meta <- read_delim("~/Desktop/ag_1k_fecal.txt", 
    "\t", escape_double = FALSE, trim_ws = TRUE)
View(Meta)

#Import Tree File ###Not Working 
#tree_file <-("~/Desktop/97_otus.tree")
#treefilename = system.file("~/Desktop/97_otus.tree", "biom-tree.phy",  package="phyloseq")
```

Import OTU file
```{r}
#Data originally downloaded from <ftp://ftp.microbio.me/AmericanGut/latest>
#Make sure to pull the correct biom file to match the meta data down for analysis. 

# To read in original .biom file use command below 
file_path<- ("~/Desktop/ag_1k_fecal.biom")
dat <- import_biom(file_path)

#Make Phyloseq values
#Taxonomy
taxonomy <- tax_table(dat)
#OTU
OTU_table<- otu_table(dat)
#MetaData
SampleData<- sample_data(Meta)
SD<-sam_data(Meta)
#Tree
#tree<- tree

#Merge
Sample_data <- (SD)
sam_cov <- as.data.frame(Sample_data)
rownames(sam_cov) <- sam_cov$"#SampleID"
sd <- sample_data(sam_cov)
sample_names(sd)
otus <- otu_table(OTU_table, taxa_are_rows = TRUE)
sample_names(otus)
tt <- tax_table(taxonomy)
ps <- phyloseq(otus, sd, tt)
ps
```


##Analysis of MetaData
First I will recode, clean, and analyze the demographics of the sample. Before I can start I must recaegorize the variables and assign values to groups I am interested in. 

```{r}
#Create a variable list which we want in Table 1
listVars <- c(Age="AGE_YEARS", AgeCat="AGE_CAT", Sex="SEX", Race="RACE", BMI="BMI_CAT", 
Education="LEVEL_OF_EDUCATION", Antibiotics="ANTIBIOTIC_HISTORY", Probiotics="PROBIOTIC_FREQUENCY",ExFreq= "EXERCISE_FREQUENCY", ExLoc="EXERCISE_LOCATION", PoolFreq="POOL_FREQUENCY", Diet="DIET_TYPE", Healthy="SUBSET_HEALTHY")

list2Vars <- c(Age_Cat="AGE_CAT", Sex="SEX", Race="RACE", BMI="BMI_CAT", 
Education="LEVEL_OF_EDUCATION", Antibiotics="ANTIBIOTIC_HISTORY", Probiotics="PROBIOTIC_FREQUENCY", ExLoc="EXERCISE_LOCATION", PoolFreq="POOL_FREQUENCY", Diet="DIET_TYPE", Healthy="SUBSET_HEALTHY")

ExFreq <-c(ExFreq= "EXERCISE_FREQUENCY")
SampleID <- c(SampleID="SampleID")

#Recode levels for current variables to clean up data
#Age

#Sex 

#Race 

#BMI

#Education 

#Antibiotics 

#Probiotics

#ExFreq 

#ExLoc 

#PoolFreq 

#Diet






#Chronic Illness
#recode each variable as 0 or 1 and then merge? like if then statements 
Chronic<-  c(Cancer="CANCER", Kidney="KIDNEY_DISEASE", DM="DIABETES", Lung="LUNG_DISEASE", ASD="ASD", IBS="IBS", IBD="IBD", Liver="LIVER_DISEASE",  CVD="CARDIOVASCULAR_DISEASE", AutoImmune="AUTOIMMUNE", Alzheimers="ALZHEIMERS", Allergies="SEASONAL_ALLERGIES", Thyroid="THYROID", Skin="SKIN_CONDITION")


#Add a variable to the dataset called chronic
MetaIdeal$ChronicIll <- MetaIdeal$CANCER + MetaIdeal$KIDNEY_DISEASE + MetaIdeal$DIABETES + MetaIdeal$LUNG_DISEASE + MetaIdeal$ASD + MetaIdeal$IBS + MetaIdeal$IBD + MetaIdeal$LIVER_DISEASE + MetaIdeal$CARDIOVASCULAR_DISEASE + MetaIdeal$SEASONAL_ALLERGIES + MetaIdeal$THYROID + MetaIdeal$SKIN_CONDITION


#Merge various diseases into that one variable

#Recode to combine levels of the data
MetaIdeal$ChronicIll <- levels(1,2,3,4)
levels(1) <- c("Diagnosed by a medical professional doctor, physician assistant","Diagnosed by an alternative medicine practitioner")
levels(2) <- c("Self-diagnosed")
levels(3) <- c("I do not have this condition")
levels(4) <- c("Unknown", "Unspecified")


#Logical Operators??????? Hertzberg
For (ChronicIll in c(MetaIdeal$CANCER, MetaIdeal$KIDNEY_DISEASE , MetaIdeal$DIABETES , MetaIdeal$LUNG_DISEASE , MetaIdeal$ASD , MetaIdeal$IBS , MetaIdeal$IBD , MetaIdeal$LIVER_DISEASE , MetaIdeal$CARDIOVASCULAR_DISEASE , MetaIdeal$SEASONAL_ALLERGIES , MetaIdeal$THYROID , MetaIdeal$SKIN_CONDITION) {
     v=get("Diagnosed by a medical professional doctor, physician assistant","Diagnosed by an alternative medicine practitioner")
     assign(v to MetaIdeal$ChronicIll)
     u=get("Self-diagnosed")
     assign(u to MetaIdeal$ChronicIll)
}

#Categorical Variables
catVars <- c(Age="AGE_CAT", Sex="SEX", Race="RACE", BMI="BMI_CAT", 
Education="LEVEL_OF_EDUCATION", Antibiotics="ANTIBIOTIC_HISTORY", Probiotics="PROBIOTIC_FREQUENCY",ExFreq= "EXERCISE_FREQUENCY", ExLoc="EXERCISE_LOCATION", PoolFreq="POOL_FREQUENCY", Diet="DIET_TYPE", Healthy="SUBSET_HEALTHY")

#Continuous Variables
contVars <- c(Age="AGE"),
  
#Demographic Variables
DemVars <- c(Age="AGE_CAT", Sex="SEX", Race="RACE", BMI="BMI_CAT", 
Education="LEVEL_OF_EDUCATION", Chronic=),

#Lifestyle Variables
LifeVars <- c(Antibiotics="ANTIBIOTIC_HISTORY", Probiotics="PROBIOTIC_FREQUENCY",ExFreq= "EXERCISE_FREQUENCY", ExLoc="EXERCISE_LOCATION", PoolFreq="POOL_FREQUENCY", Diet="DIET_TYPE"),
```

Run initial analysis to see if recoding and grouping worked. 
```{r}
#Using "tableone" package

#Define categorical variables
CreateCatTable(vars= catVars, data=D, includeNA = FALSE, test = TRUE,testApprox = chisq.test, argsApprox = list(correct = TRUE),
  testExact = fisher.test, argsExact = list(workspace = 2 * 10^5),
  smd = TRUE)

#Total Population Table 1
table1 <- CreateTableOne(vars = listVars, data = MetaIdeal, factorVars = catVars),
table1,
```

Create Table 1 for men and women and to compare their means and proportions to see if this is a more meaningful way to present the data. 
```{r}
# Create table by exercise frequency category 
#Define categorical variables

ExTable1<- CreateTableOne(vars=list2Vars, strata=ExFreq, data=D, factorVars=catVars, includeNA = FALSE,
  test = TRUE, testApprox = chisq.test, argsApprox = list(correct = TRUE),
  testExact = fisher.test, argsExact = list(workspace = 2 * 10^5),
  testNormal = oneway.test, argsNormal = list(var.equal = TRUE),
  testNonNormal = kruskal.test, argsNonNormal = list(NULL), smd = TRUE),
```

Export to Microsoft Word
```{r}
ExTable1 <- print(ExTable1),

# The script
docx( ) %>% 
     addFlexTable(ExTable1 %>%
     FlexTable(header.cell.props = cellProperties( background.color = "#003366"),
               header.text.props = textBold( color = "white" ),
               add.rownames = TRUE ) %>%
               setZebraStyle( odd = "#DDDDDD", even = "#FFFFFF" ) ) %>%
     writeDoc(file = "~/Desktop/Extable1.docx"),
```
***Need to recode categories for variables, and modify code to delete test column and add a total. Figure out how to make continuous variables show mean and SD. 
Also figure out how p value was calculated. 

Below are explanations for real tables I would like to make. 

Figure 1: Demographic Information by Exercise Frequency
```{r}
#Age, BMI, Race, Gender, Education, Region or country of Residence, chronic condition


```


Figure 2: Lifestyle habits by Exercise Frequency
```{r}
#Diet, Exercise location, pool, antibiotic, probiotic 


```


Figure 3: Chronic Conditions by Exercise Frequency
```{r}
#Investigate Chronic Condition Frequencies
ExTable3<- CreateTableOne(vars=Chronic, strata=ExFreq, data=MetaIdeal, factorVars=catVars, includeNA = FALSE,
  test = TRUE, testApprox = chisq.test, argsApprox = list(correct = TRUE),
  testExact = fisher.test, argsExact = list(workspace = 2 * 10^5),
  testNormal = oneway.test, argsNormal = list(var.equal = TRUE),
  testNonNormal = kruskal.test, argsNonNormal = list(NULL), smd = TRUE),
ExTable3
```

Figure 4: Alpha Diversity

Figure 5: 

Figure 6: Beta Diversity By Exercise Frequency

Figure 7: Beta Diversity By Exercise Location

##Preliminary Synthesis/Discussion of Results

##Ancillary Questions
-How do the skewed demographics affect the data? This group is mostly cacuasian and has at least a Bachelor's degreee or has attended graduate school. 
-Should children be removed from the analysis?
-Would including birth method/ method of feeding received as an infant change any of the results?

##References
Put references for the exercise part for why I changed 


##GitHub Repository
Ther RMarkdown file used to create this document can be found in the repositor at <https://github.com/amonda/American-Gut>. The name of the file is "Milestone2.Rmd".