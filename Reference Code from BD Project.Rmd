---
title: "Code from Big Data Project markdown for reference"
author: "Alyssa Monda"
date: "3/19/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
---
title: "Untitled"
author: "Alyssa Monda"
date: "2/22/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(biom)
library(devtools)
library(knitr)
library(biomformat)
library(mixOmics)
library(tidyverse)
library(vegan)
library(mixOmics)
```

```{r}
source('http://bioconductor.org/biocLite.R')
biocLite('phyloseq')
```

```{r}
devtools::install_github("biomformat", "joey711")
```

```{r}
library(readxl)
American_Gut_Meta_Data_New <- read_excel("~/Desktop/American Gut Meta_Data_New.xlsx")
View(American_Gut_Meta_Data_New)
```

```{r}
#Data downloaded from ftp://ftp.microbio.me/AmericanGut/latest/04-meta/ag-gg-100nt.biom
file_path <- "~/Desktop/Big Data/Big-Data-Project/ag-gg-100nt.biom"
dat <- read_biom(file_path)
```

```{r}
#You can't go straight from a "sparse Matrix" to a data frame! 
otu_table <- as.data.frame(as.matrix(biom_data(dat)))
```

```{r}
####import metadata how?
#taxonomy <- observation_metadata(dat)
```

```{r}
######fix
meta <- Big_Data_Project_Ideal_Meta_Data_Set_copy
```


```{r}
head(otu_table[,1:10])
```


```{r}
head(Big_Data_Project_Ideal_Meta_Data_Set_copy[,1:4])
```


```{r}
head(taxonomy)
```
##Clean data

Assign data from the OTU table to two objects. One with only the taxa information and the second with the information from the OTU table. (Only purpose here was to make following online code instructions easier.)
```{r}
taxa.names <- taxonomy
dat2 <- otu_table
```

Itâ€™s usually a good idea to to drop samples with low observations. There is a very low probability your sample only has 10 or even just 100 microbes in it.

First, create an object that contains number of observances for each sample (sums each column).
```{r}
s_abundances<-apply(dat2,2,sum)
```

Next, split the OTU table into two matrices: one with low abundances and one with high abundances. Currently the threshold is set at 1000 but you can change the number in both lines.

```{r}
bads<-dat2[,s_abundances<1000]
goods<-dat2[,s_abundances>1000]
```

To see how many poor samples will be removed from the OTU table:
```{r}
ncol(dat2)-ncol(goods)
ncol(bads)
```

Now replace the old OTU table with the new one that just contains good markers.

```{r}
dat2<-goods
```

You can save the bad and good reads as a csv file for future use if necessary. Code is not currently found in this file. Use command write and create a csv. 

#Moving from Absolute Abundances to Relative Abundances

Right now, observances of each OTU are reported as absolute abundances. Each OTU observance is the original number generated by OTU picking and the like in QIIME. Sometimes there are specific reasons why you might want to leave the abundances as absolute abundances, however standardization is needed the majority of the time, in order to make samples comparable to each other. In standardization the absolute number of observances for an OTU becomes a fraction of the total observances in that sample.

```{r}
dat2 <- scale(dat2, center=F, scale=colSums(dat2))
```

To begin, transpose the OTU table so that the OTU ID numbers become the top row rather than the first column.

```{r}
dat2t <-t(dat2)
```


```{r}
write.csv(dat2t, "AG_GoodReads_Transpose.csv")
```

Can't get this code to work, so instead I will do it the long way. Export to excel and wrangle it externally. Then import, and have different data objects for each level of the taxonomy. Skip the Next 2 R chunks. 
```{r}
#Create separate data for each level of the taxonomy. 
d.phylum = otu2taxonomy(dat2t,level=2,taxa=taxa.names)
d.class = otu2taxonomy(dat2t,level=3,taxa=taxa.names)
d.order = otu2taxonomy(dat2t,level=4,taxa=taxa.names)
d.family = otu2taxonomy(dat2t,level=5,taxa=taxa.names)
d.genus = otu2taxonomy(dat2t,level=6,taxa=taxa.names)
d.species = otu2taxonomy(dat2t,level=7,taxa=taxa.names)
```

To look at the output, transpose and export.
```{r}
#Transpose data. 
phylum2 <-t(d.phylum)
class2 <-t(d.class)
order2 <-t(d.order)
family2 <-t(d.family)
genus2 <-t(d.genus)
species2 <-t(d.species)
#Export. 
write.table(phylum2, file="output/phyla.csv", col.names=NA,row.names=TRUE, sep=",", quote=FALSE) 
write.table(class2, file="output/classes.csv", col.names=NA,row.names=TRUE, sep=",", quote=FALSE)
write.table(order2, file="output/orders.csv", col.names=NA,row.names=TRUE, sep=",", quote=FALSE)
write.table(family2, file="output/families.csv", col.names=NA,row.names=TRUE, sep=",", quote=FALSE)
write.table(genus2, file="output/genera.csv", col.names=NA,row.names=TRUE, sep=",", quote=FALSE)
write.table(species2, file="output/species.csv", col.names=NA,row.names=TRUE, sep=",", quote=FALSE)
```

Data wrangle externally to create separate tables for each level of taxonomy. Using the xlsx package to export. Install and open package first. 

```{r}
write.csv(taxonomy, "taxonomy.csv")
```

In excel I created separate files with ID and taxa level. Now they need to be imported back into R. 

```{r}
library(readxl)
d.phylum <- read_excel("~/Desktop/Big Data/Big-Data-Project/d.phylum.xlsx")
View(d.phylum)
```

```{r}
library(readxl)
d.class <- read_excel("~/Desktop/Big Data/Big-Data-Project/d.class.xlsx")
View(d.class)
```

```{r}
library(readxl)
d.order <- read_excel("~/Desktop/Big Data/Big-Data-Project/d.order.xlsx")
View(d.order)
```

```{r}
library(readxl)
d.family <- read_excel("~/Desktop/Big Data/Big-Data-Project/d.family.xlsx")
View(d.family)
```

```{r}
library(readxl)
d.genus <- read_excel("~/Desktop/Big Data/Big-Data-Project/d.genus.xlsx")
View(d.genus)
```


```{r}
library(readxl)
d.species <- read_excel("~/Desktop/Big Data/Big-Data-Project/d.species.xlsx")
View(d.species)
```

```{r}
#Transpose data. 
phylum2 <-t(d.phylum)
class2 <-t(d.class)
order2 <-t(d.order)
family2 <-t(d.family)
genus2 <-t(d.genus)
species2 <-t(d.species)
```

Exporting allows you to analyze your OTU data at various taxonomical levels within and outside of R.
```{r}
# Export
write.csv(phylum2, "phylum2.csv")
write.csv(class2, "class2.csv")
write.csv(order2, "order2.csv")
write.csv(family2, "family2.csv")
write.csv(genus2, "genus2.csv")
write.csv(species2, "species2.csv")
```

###Merge MetaData and OTUs ****THIS DID NOT WORK****
```{r}
#merge OTU and taxonomy
mergeOTU<-merge(otu_table, taxonomy, by="row.names",all.x=FALSE)
```

Flip merged OTU table so it can be merged with metadata
```{r}
TransposeOTU <-t(mergeOTU)
```

```{r}
# Export
write.csv(TransposeOTU, "TransposeOTU.csv")
```

```{r}
# Export
write.csv(Full_AG_Data, "Full_Ag_Data.csv")
```

```{r}
#merge OTU and metadata
Full_AG_Data<-merge(American_Gut_Meta_Data_New,TransposeOTU, by="row.names",all.x=FALSE)
```

Write csv for external analysis, if necessary.
```{r}
# Export
write.csv(Full_AG_Data, "Full_Ag_Data.csv")
```


Code from web- rewrite
```{r}
mergephylum<-merge(meta, d.phylum, by="row.names",all.x=FALSE)
```

```{r}
dim(meta)
dim(d.phylum)
dim(mergephylum)ncol
```

```{r}
write.table(mergephylum, file="output/mergephylum.csv", col.names=NA,row.names=TRUE, sep=",", quote=FALSE)
```

#Reorder by variable

Need to use the exact name of the variable so call the names to identify variable.
```{r}
colnames(meta)
```
This will cause the table to be rearranged by increasing value of the VARIABLE (or alphabetical order) and then by the Row.names or Sample ID/Names.
```{r}
reordermerge <- mergephylum[order(mergephylum$VARIABLE, mergephylum$Row.names),]
```

This next set of  script splits OTU table and metadata again so that the heatmap will only display OTU data rather than metadata as well. It involves removing columns, renaming the rows and changing the format of the object to a matrix.
```{r}
(OTUcol1<-ncol(meta)+2)
(OTUcol2<-ncol(reordermerge))
justOTU<-reordermerge[,OTUcol1:OTUcol2]
justOTU[1:5,1:5]
rownames(justOTU[1:10,])
rownames(justOTU)<-reordermerge$Row.names
rownames(justOTU[1:10,])
justOTU2<-as.matrix(t(justOTU))
justOTU2[1:5,1:5]
```

###Heatmap

```{r}
install.packages("gplots")
library(gplots)
```

```{r}
heatmap.2(justOTU2,Rowv=TRUE, Colv=FALSE, scale="column", trace="none", col=redgreen, xlab="sample", ylab="phylum", margins=c(10,15))
```





#PCoA Plot

```{r}
pca(dat2,
ncomp = 2,
center = TRUE,
scale = FALSE,
max.iter = 500,
tol = 1e-09,
logratio = 'none',  # one of ('none','CLR','ILR')
ilr.offset = 0.001,
V = NULL,
multilevel = NULL)
```


```
 next to merge? 

```{r}
metadata = MetadataMap.from_file('American_Gut_Meta_Data_New''ag-cleaned.txt')
table = load_table('ag-gg-100nt.biom')
table.add_metadata(metadata)
```



#With Steve and Vicki3/17
```{r}
ps <- phyloseq(otu_table(goods, taxa_are_rows=TRUE), 
               sample_data(meta), 
               tax_table(taxonomy))
ps

str(myotu)


ps <- phyloseq(myotu,sample_data(meta), tax_table(taxonomy))
```

Attempt to fix error. Flip metadata so it matches????
```{r}
TMeta <-t(meta)
```




```{r}
plot_richness(ps, x="Day", measures=c("Shannon", "Simpson"), color="When") + theme_bw()
```



References 
<https://www.r-bloggers.com/from-otu-table-to-heatmap/>
<https://joey711.github.io/phyloseq/import-data.html>